name: Avica RDP via Serveo TCP

on:
  workflow_dispatch:

jobs:
  run-rdp:
    runs-on: windows-2022

    steps:
      - name: Enable RDP Access
        run: |
          Write-Host "Enabling RDP..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Write-Host "RDP Enabled Successfully"

      - name: Create RDP User
        run: |
          Write-Host "Creating RDP User..."
          $Password = ConvertTo-SecureString "RDP@2024Secure!" -AsPlainText -Force
          try {
              New-LocalUser -Name "rdpuser" -Password $Password -PasswordNeverExpires -AccountNeverExpires -ErrorAction SilentlyContinue
          } catch {
              Write-Host "User might already exist, continuing..."
          }
          Add-LocalGroupMember -Group "Administrators" -Member "rdpuser" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "rdpuser" -ErrorAction SilentlyContinue
          Write-Host "User Created: rdpuser"

      - name: Install OpenSSH
        run: |
          Write-Host "Downloading OpenSSH..."
          $maxRetries = 3
          $retryCount = 0
          $downloaded = $false
          
          while (-not $downloaded -and $retryCount -lt $maxRetries) {
              try {
                  curl.exe -s -L -o C:\openssh.zip https://github.com/PowerShell/Win32-OpenSSH/releases/download/v9.5.0.0p1-Beta/OpenSSH-Win64.zip
                  if (Test-Path "C:\openssh.zip") {
                      $downloaded = $true
                      Write-Host "OpenSSH downloaded"
                  }
              } catch {
                  $retryCount++
                  Write-Host "Retry $retryCount of $maxRetries..."
                  Start-Sleep -Seconds 3
              }
          }
          
          if (-not $downloaded) {
              Write-Host "Trying alternative method..."
              Invoke-WebRequest -Uri "https://github.com/PowerShell/Win32-OpenSSH/releases/download/v9.5.0.0p1-Beta/OpenSSH-Win64.zip" -OutFile "C:\openssh.zip"
          }
          
          Write-Host "Extracting OpenSSH..."
          Expand-Archive -Path C:\openssh.zip -DestinationPath C:\ -Force
          
          if (Test-Path "C:\OpenSSH-Win64\ssh.exe") {
              Write-Host "OpenSSH ready"
          } else {
              Write-Host "ERROR: SSH not found!"
              exit 1
          }

      - name: Create Serveo TCP Tunnel for RDP
        run: |
          Write-Host "Creating Serveo TCP tunnel for RDP port 3389..."
          
          New-Item -Path "C:\serveo.log" -ItemType File -Force | Out-Null
          
          $process = Start-Process -FilePath "C:\OpenSSH-Win64\ssh.exe" -ArgumentList "-o", "StrictHostKeyChecking=no", "-o", "ServerAliveInterval=30", "-o", "ServerAliveCountMax=5", "-R", "0:localhost:3389", "serveo.net" -NoNewWindow -PassThru -RedirectStandardOutput "C:\serveo.log" -RedirectStandardError "C:\serveo_error.log"
          
          Write-Host "Waiting for tunnel to establish..."
          Start-Sleep -Seconds 15
          
          $tcpUrl = ""
          $serveoHost = ""
          $serveoPort = ""
          
          if (Test-Path "C:\serveo.log") {
              $logContent = Get-Content "C:\serveo.log" -Raw
              Write-Host "Serveo Output:"
              Write-Host $logContent
              
              if ($logContent -match "tcp://serveo\.net:(\d+)") {
                  $serveoPort = $matches[1]
                  $serveoHost = "serveo.net"
                  $tcpUrl = "tcp://serveo.net:$serveoPort"
                  Write-Host "TCP Tunnel established!"
              } else {
                  Write-Host "Could not extract port from logs"
              }
          }
          
          if (Test-Path "C:\serveo_error.log") {
              $errorContent = Get-Content "C:\serveo_error.log" -Raw
              if ($errorContent) {
                  Write-Host "Errors:"
                  Write-Host $errorContent
              }
          }
          
          if ($process.HasExited) {
              Write-Host "SSH process exited!"
              exit 1
          } else {
              Write-Host "SSH tunnel running"
          }
          
          $rdpAddress = "${serveoHost}:${serveoPort}"
          
          $connectionInfo = @"
          ============================================
                RDP CONNECTION via SERVEO TCP
          ============================================
          Server  : $serveoHost
          Port    : $serveoPort
          Full    : $tcpUrl
          
          Username: rdpuser
          Password: RDP@2024Secure!
          ============================================
          
          HOW TO CONNECT:
          1. Open Remote Desktop Connection
          2. Computer: $rdpAddress
          3. Username: rdpuser
          4. Password: RDP@2024Secure!
          5. Click Connect
          ============================================
          "@
          
          Write-Host $connectionInfo
          $connectionInfo | Out-File -FilePath "C:\rdp_info.txt" -Encoding UTF8
          
          echo "SERVEO_HOST=$serveoHost" >> $env:GITHUB_ENV
          echo "SERVEO_PORT=$serveoPort" >> $env:GITHUB_ENV
          echo "TCP_URL=$tcpUrl" >> $env:GITHUB_ENV

      - name: Download and Start Avica
        run: |
          Write-Host "Downloading Avica..."
          curl.exe -s -L -o AvicaLite.exe https://download.avica.com/AvicaLite_v8.0.8.9.exe
          if (Test-Path "AvicaLite.exe") {
              Write-Host "Starting Avica..."
              Start-Process -FilePath ".\AvicaLite.exe" -ErrorAction SilentlyContinue
          } else {
              Write-Host "Warning: Avica download failed"
          }

      - name: Capture and Process OCR
        id: ocr_engine
        shell: powershell
        continue-on-error: true
        run: |
          Start-Sleep -s 25
          $process = Get-Process -Name "AvicaLite" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($process) {
              try {
                  Add-Type -AssemblyName System.Windows.Forms, System.Drawing
                  $Screen = [System.Windows.Forms.Screen]::PrimaryScreen
                  $Bitmap = New-Object System.Drawing.Bitmap($Screen.Bounds.Width, $Screen.Bounds.Height)
                  $Graphics = [System.Drawing.Graphics]::FromImage($Bitmap)
                  $Graphics.CopyFromScreen($Screen.Bounds.X, $Screen.Bounds.Y, 0, 0, $Bitmap.Size)
                  $Bitmap.Save("$env:USERPROFILE\Desktop\pic.png", [System.Drawing.Imaging.ImageFormat]::Png)
                  Write-Host "Screenshot captured"
              } catch {
                  Write-Host "Screenshot failed"
              }
          }
          
          try {
              curl.exe -s -L -o screenshot.py https://gitlab.com/MR.English2008/avica/-/raw/main/OCR_Avica.py
              $env:PYTHONWARNINGS="ignore"
              cmd /c "python screenshot.py > nul 2>&1"
          } catch {
              Write-Host "OCR processing failed"
          }

      - name: Display Final Connection Info
        run: |
          Write-Host ""
          Write-Host "============================================"
          Write-Host "     FINAL CONNECTION SUMMARY"
          Write-Host "============================================"
          Write-Host ""
          
          Write-Host "RDP via Serveo TCP:"
          if (Test-Path "C:\rdp_info.txt") {
              Get-Content "C:\rdp_info.txt"
          } else {
              Write-Host "Server: $env:SERVEO_HOST"
              Write-Host "Port: $env:SERVEO_PORT"
              Write-Host "Username: rdpuser"
              Write-Host "Password: RDP@2024Secure!"
          }
          
          Write-Host ""
          Write-Host "AVICA ACCESS:"
          Write-Host "Avica ID  : ${{ steps.ocr_engine.outputs.id }}"
          Write-Host "Avica Pass: ${{ steps.ocr_engine.outputs.pass }}"
          
          Write-Host ""
          Write-Host "============================================"
          Write-Host "Credits: MR.English2008"
          Write-Host "Telegram: https://t.me/ME2008_RDP"
          Write-Host "============================================"
          Write-Host ""
          Write-Host "Connection will stay alive for 6 hours..."

      - name: Keep Connection Alive
        run: |
          $startTime = Get-Date
          $endTime = $startTime.AddHours(6)
          $checkInterval = 180
          
          Write-Host "Starting connection monitor..."
          
          while ((Get-Date) -lt $endTime) {
              $elapsed = ((Get-Date) - $startTime).ToString("hh\:mm\:ss")
              $remaining = ($endTime - (Get-Date)).ToString("hh\:mm\:ss")
              
              Write-Host "Elapsed: $elapsed | Remaining: $remaining"
              
              $sshProcess = Get-Process -Name "ssh" -ErrorAction SilentlyContinue
              if (-not $sshProcess) {
                  Write-Host "SSH tunnel died! Restarting..."
                  
                  Start-Process -FilePath "C:\OpenSSH-Win64\ssh.exe" -ArgumentList "-o", "StrictHostKeyChecking=no", "-o", "ServerAliveInterval=30", "-R", "0:localhost:3389", "serveo.net" -NoNewWindow -PassThru -RedirectStandardOutput "C:\serveo.log" -RedirectStandardError "C:\serveo_error.log"
                  
                  Start-Sleep -Seconds 10
                  
                  if (Test-Path "C:\serveo.log") {
                      $newLog = Get-Content "C:\serveo.log" -Raw
                      if ($newLog -match "tcp://serveo\.net:(\d+)") {
                          $newPort = $matches[1]
                          Write-Host "Tunnel restarted - New port: $newPort"
                      }
                  }
              } else {
                  Write-Host "SSH tunnel healthy"
              }
              
              $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
              if ($rdpService.Status -eq "Running") {
                  Write-Host "RDP service running"
              } else {
                  Write-Host "RDP service not running"
              }
              
              Start-Sleep -Seconds $checkInterval
          }
          
          Write-Host "Session completed after 6 hours"
