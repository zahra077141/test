name: Windows RDP (Tailscale Only)

on:
  workflow_dispatch:

concurrency:
  group: github-rdp-singleton
  cancel-in-progress: false

defaults:
  run:
    shell: pwsh

env:
  # --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù€ RDP ---
  RDP_USER: Bullettemporary
  RDP_PASS: Bullet@12345
  
  # --- Ù…ÙØ§ØªÙŠØ­ Tailscale (Ù…Ø«Ø¨ØªØ© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª) ---
  TS_AUTHKEY: "tskey-auth-kCaD5987Zy11CNTRL-VgT8DTEgk1Vnuvmz8Jig1VKv89mms735"
  # Ø§Ù„Ù…ÙØªØ§Ø­ Ø£Ø¯Ù†Ø§Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù…Ù† ÙŠØ­ØªØ§Ø¬Ù‡ØŒ Ù„ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù€ AuthKey Ø£Ø¹Ù„Ø§Ù‡
  TS_API_KEY: "tskey-api-kuUgA1492V11CNTRL-iw9XrCfJBhEPRfPX7eAGhEPExxVG8JKg"

jobs:
  rdp-session:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: ğŸ” Enable RDP Access
        run: |
          $u="${{ env.RDP_USER }}"; $p="${{ env.RDP_PASS }}"
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ØªØ­Ø¯ÙŠØ«Ù‡
          if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          } else {
            Set-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Enable-LocalUser -Name $u
          }
          # ÙØªØ­ Ø§Ù„Ù…Ù†ÙØ° ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          Write-Host "RDP User '$u' prepared."

      - name: ğŸ”Œ Install & Connect Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          choco install tailscale -y --no-progress
          
          Write-Host "Connecting to Tailscale..."
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ env.TS_AUTHKEY }}" --hostname "github-rdp-bullet" --accept-routes
          
          Write-Host "Tailscale is up! You can now connect via Tailscale IP."

      - name: â³ Keep Alive (355 Minutes)
        run: |
          $runtime = 355
          $end = (Get-Date).AddMinutes($runtime)
          Write-Host "Session active for $runtime minutes..."
          
          while((Get-Date) -lt $end){
            $left = [int]([math]::Ceiling(($end - (Get-Date)).TotalMinutes))
            Write-Host "Alive... ($left minutes remaining)"
            Start-Sleep -Seconds 60
          }
          Write-Host "Time limit reached. Shutting down."

