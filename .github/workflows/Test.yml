name: RDP + Win10 (Pinggy)

on:
  workflow_dispatch:

jobs:
  run-rdp:
    runs-on: windows-latest
    steps:
      - name: Enable RDP & Set Password
        shell: powershell
        run: |
          # تعيين كلمة المرور للمستخدم runneradmin
          $password = "MR.English2008"
          net user runneradmin $password
          
          # تفعيل RDP في النظام
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          
          # فتح المنفذ في الجدار الناري
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1

      - name: Start Pinggy Tunnel (RDP)
        shell: powershell
        run: |
          # تشغيل Pinggy في الخلفية وتوجيه المخرجات لملف نصي
          # نستخدم المنفذ 3389 وهو الخاص بـ RDP
          Start-Job -ScriptBlock {
              cmd /c "ssh -o StrictHostKeyChecking=no -p 443 -R0:localhost:3389 tcp@a.pinggy.io > $env:TEMP\pinggy.log 2>&1"
          }
          
          Write-Host "Waiting for Pinggy to generate URL..."
          $timeout = 0
          $found = $false
          
          # محاولة قراءة الملف لمدة 30 ثانية حتى يظهر الرابط
          while ($timeout -lt 30) {
              Start-Sleep -Seconds 2
              if (Test-Path "$env:TEMP\pinggy.log") {
                  $logContent = Get-Content "$env:TEMP\pinggy.log" -Raw
                  # البحث عن أي رابط بصيغة tcp://...
                  if ($logContent -match "tcp://([^:]+):(\d+)") {
                      $publicUrl = $matches[1]
                      $publicPort = $matches[2]
                      
                      "PINGGY_URL=$publicUrl" | Out-File -Append $env:GITHUB_ENV
                      "PINGGY_PORT=$publicPort" | Out-File -Append $env:GITHUB_ENV
                      $found = $true
                      break
                  }
              }
              $timeout++
          }
          
          if (-not $found) {
              Write-Error "Failed to get Pinggy URL. Check the log."
              Get-Content "$env:TEMP\pinggy.log"
          }

      - name: Runner Status & Keep Alive
        shell: powershell
        run: |
          $endTime = (Get-Date).AddHours(6)
          Write-Host "========================================="
          Write-Host "Thanks to MR.English2008 for this work"
          Write-Host "Telegram: https://t.me/ME2008_RDP"
          Write-Host "========================================="
          Write-Host ""
          Write-Host "CONNECTION DETAILS (USE RDP APP):"
          Write-Host "User: runneradmin"
          Write-Host "Password: MR.English2008"
          Write-Host ""
          Write-Host "Host: $env:PINGGY_URL:$env:PINGGY_PORT"
          Write-Host "(Copy the Host above and put it in Remote Desktop Connection)"
          Write-Host ""
          Write-Host "========================================="
          Write-Host "Pinggy is 100% FREE - No registration!"
          Write-Host "Active for 6 hours"
          Write-Host "========================================="
          Write-Host ""

          while ((Get-Date) -lt $endTime) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Status: Online | Connect to: $env:PINGGY_URL:$env:PINGGY_PORT"
              Start-Sleep -Seconds 60
          }
