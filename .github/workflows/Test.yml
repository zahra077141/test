name: RDP + Win10 (Pinggy Fix)

on:
  workflow_dispatch:

jobs:
  run-rdp:
    runs-on: windows-latest
    steps:
      - name: Enable RDP & Set Password
        shell: powershell
        run: |
          # تعيين كلمة المرور
          $password = "MR.English2008"
          net user runneradmin $password
          
          # تفعيل RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1

      - name: Start Pinggy Tunnel
        shell: powershell
        run: |
          # حذف أي ملفات سجل سابقة
          if (Test-Path "$env:TEMP\pinggy.log") { Remove-Item "$env:TEMP\pinggy.log" }

          # تشغيل Pinggy باستخدام Start-Process مع تجاهل تام لأسئلة الأمان
          # ملاحظة: نستخدم NUL لمنع حفظ بصمة السيرفر وبالتالي منع السؤال عنها
          $sshArgs = @(
              "-p", "443",
              "-o", "StrictHostKeyChecking=no",
              "-o", "UserKnownHostsFile=NUL",
              "-o", "ServerAliveInterval=30",
              "-R0:localhost:3389",
              "tcp@a.pinggy.io"
          )

          Write-Host "Starting Pinggy Tunnel..."
          $pinggyProc = Start-Process ssh -ArgumentList $sshArgs -PassThru -NoNewWindow -RedirectStandardOutput "$env:TEMP\pinggy.log" -RedirectStandardError "$env:TEMP\pinggy_err.log"
          
          # انتظار 10 ثواني للتأكد من الاتصال
          Start-Sleep -Seconds 10

          # محاولة استخراج الرابط
          $logContent = Get-Content "$env:TEMP\pinggy.log" -Raw -ErrorAction SilentlyContinue
          
          if ($logContent -match "tcp://([^:]+):(\d+)") {
              $publicUrl = $matches[1]
              $publicPort = $matches[2]
              Write-Host "URL FOUND: $publicUrl:$publicPort"
              "PINGGY_URL=$publicUrl" | Out-File -Append $env:GITHUB_ENV
              "PINGGY_PORT=$publicPort" | Out-File -Append $env:GITHUB_ENV
          } else {
              Write-Error "Pinggy URL not found yet. Showing logs for debugging:"
              Write-Host "=== STDOUT ==="
              Get-Content "$env:TEMP\pinggy.log" -ErrorAction SilentlyContinue
              Write-Host "=== STDERR ==="
              Get-Content "$env:TEMP\pinggy_err.log" -ErrorAction SilentlyContinue
          }

      - name: Runner Status & Keep Alive
        shell: powershell
        run: |
          $endTime = (Get-Date).AddHours(6)
          
          # طباعة المعلومات فقط إذا تم العثور على الرابط
          if ($env:PINGGY_URL) {
            Write-Host "========================================="
            Write-Host "   RDP CONNECTION SUCCESSFUL"
            Write-Host "========================================="
            Write-Host "PC Name/Host: $env:PINGGY_URL:$env:PINGGY_PORT"
            Write-Host "User:         runneradmin"
            Write-Host "Password:     MR.English2008"
            Write-Host "========================================="
          } else {
            Write-Warning "Connection failed. Check logs above."
          }

          while ((Get-Date) -lt $endTime) {
              if ($env:PINGGY_URL) {
                 Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ONLINE | Host: $env:PINGGY_URL:$env:PINGGY_PORT"
              } else {
                 Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WAITING/RETRYING..."
                 # محاولة قراءة الرابط مرة أخرى في حال تأخر
                 $log = Get-Content "$env:TEMP\pinggy.log" -Raw -ErrorAction SilentlyContinue
                 if ($log -match "tcp://([^:]+):(\d+)") {
                    $env:PINGGY_URL = $matches[1]
                    $env:PINGGY_PORT = $matches[2]
                 }
              }
              Start-Sleep -Seconds 60
          }

