name: VPS API Control Pro Runner
on:
  workflow_dispatch:

jobs:
  api-service:
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          # إضافة psutil لجلب معلومات النظام الدقيقة كما في السكربت المرفق
          pip install flask flask-socketio eventlet psutil

      - name: Create API Script
        run: |
          cat << 'EOF' > api_server.py
          import os, subprocess, threading, time, platform, shutil, json
          from flask import Flask, request, jsonify
          from flask_socketio import SocketIO, emit
          from werkzeug.utils import secure_filename

          app = Flask(__name__)
          app.config["SECRET_KEY"] = "vps_pro_secret_2024"
          socketio = SocketIO(app, cors_allowed_origins="*", async_mode='eventlet')

          running_commands = {}
          cmd_lock = threading.Lock()

          def format_size(bytes):
              for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
                  if bytes < 1024.0: return f"{bytes:.1f} {unit}"
                  bytes /= 1024.0

          # --- إدارة الملفات (كاملة حسب نسخة Pro) ---

          @app.route("/api/files", methods=["POST"])
          def list_files():
              data = request.get_json() or {}
              path = data.get("path", "/")
              try:
                  if not os.path.exists(path): return jsonify({"success": False, "error": "المسار غير موجود"})
                  items = []
                  for item in os.listdir(path):
                      ipath = os.path.join(path, item)
                      try:
                          stat = os.stat(ipath)
                          items.append({
                              "name": item, "path": ipath,
                              "is_dir": os.path.isdir(ipath),
                              "size": "مجلد" if os.path.isdir(ipath) else format_size(stat.st_size),
                              "modified": time.strftime("%Y-%m-%d %H:%M", time.localtime(stat.st_mtime))
                          })
                      except: continue
                  return jsonify({"success": True, "files": items})
              except Exception as e: return jsonify({"success": False, "error": str(e)})

          @app.route("/api/create", methods=["POST"])
          def create_item():
              data = request.get_json()
              path, itype, content = data.get("path"), data.get("type"), data.get("content", "")
              try:
                  if itype == "folder": os.makedirs(path, exist_ok=True)
                  else:
                      with open(path, "w", encoding="utf-8") as f: f.write(content)
                  return jsonify({"success": True})
              except Exception as e: return jsonify({"success": False, "error": str(e)})

          @app.route("/api/read", methods=["POST"])
          def read_file():
              path = request.get_json().get("path")
              try:
                  with open(path, "r", encoding="utf-8") as f: content = f.read()
                  return jsonify({"success": True, "content": content})
              except Exception as e: return jsonify({"success": False, "error": str(e)})

          @app.route("/api/write", methods=["POST"])
          def write_file():
              data = request.get_json()
              path, content = data.get("path"), data.get("content")
              try:
                  with open(path, "w", encoding="utf-8") as f: f.write(content)
                  return jsonify({"success": True})
              except Exception as e: return jsonify({"success": False, "error": str(e)})

          @app.route("/api/delete", methods=["POST"])
          def delete_item():
              path = request.get_json().get("path")
              try:
                  if os.path.isdir(path): shutil.rmtree(path)
                  else: os.remove(path)
                  return jsonify({"success": True})
              except Exception as e: return jsonify({"success": False, "error": str(e)})

          # --- معلومات النظام المتقدمة ---

          @app.route("/api/sysinfo", methods=["GET"])
          def sys_info():
              try:
                  import psutil
                  cpu = psutil.cpu_count()
                  mem = psutil.virtual_memory()
                  disk = psutil.disk_usage('/')
                  load = os.getloadavg() if hasattr(os, 'getloadavg') else (0,0,0)
                  info = {
                      "os": f"{platform.system()} {platform.release()}",
                      "cpu_count": cpu,
                      "memory": f"{format_size(mem.used)} / {format_size(mem.total)}",
                      "disk": f"{format_size(disk.used)} / {format_size(disk.total)}",
                      "load": f"{load[0]:.2f}, {load[1]:.2f}, {load[2]:.2f}",
                      "uptime": time.ctime(psutil.boot_time())
                  }
                  return jsonify({"success": True, "info": info})
              except Exception as e: return jsonify({"success": False, "error": str(e)})

          # --- الطرفية التفاعلية ---

          @socketio.on('run_cmd')
          def handle_cmd(data):
              cmd = data.get('cmd')
              sid = request.sid
              def execute():
                  proc = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)
                  with cmd_lock: running_commands[sid] = proc
                  for line in iter(proc.stdout.readline, ''):
                      socketio.emit('output', {'line': line}, room=sid)
                  proc.wait()
                  socketio.emit('output', {'line': f"\n[Process Finished: {proc.returncode}]\n"}, room=sid)
              threading.Thread(target=execute).start()

          @socketio.on('stop_cmd')
          def stop_cmd():
              sid = request.sid
              with cmd_lock:
                  proc = running_commands.get(sid)
                  if proc: proc.terminate(); socketio.emit('output', {'line': "\n[Process Terminated]\n"}, room=sid)

          if __name__ == "__main__":
              socketio.run(app, host="0.0.0.0", port=8080)
          EOF

      - name: Start API Server
        run: |
          nohup python3 api_server.py > server.log 2>&1 &
          sleep 5
          cat server.log

      - name: Open Tunnel and Keep Alive
        run: |
          # تأكد من استخدام اسم فريد للنفق
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -R pro-vps-control:80:localhost:8080 serveo.net
