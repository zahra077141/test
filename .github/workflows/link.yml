name: Windows RDP (Manual Tailscale Login)

on:
  workflow_dispatch:

concurrency:
  group: github-rdp-singleton
  cancel-in-progress: false

defaults:
  run:
    shell: pwsh

env:
  # --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù€ RDP ---
  RDP_USER: no8lo
  RDP_PASS: my@12345

jobs:
  rdp-session:
    runs-on: windows-2022
    timeout-minutes: 370
    steps:
      - name: ğŸ” Enable RDP Access
        run: |
          $u="${{ env.RDP_USER }}"; $p="${{ env.RDP_PASS }}"
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
          if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          } else {
            Set-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Enable-LocalUser -Name $u
          }
          # ÙØªØ­ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          Write-Host "RDP User '$u' is ready."

      - name: â¬‡ï¸ Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          choco install tailscale -y --no-progress

      - name: ğŸ”— Generate Auth Link & Wait
        # Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ø³ØªÙ†ØªØ¸Ø± Ø­ØªÙ‰ ØªÙ‚ÙˆÙ… Ø£Ù†Øª Ø¨ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
        timeout-minutes: 15 # Ù„Ø¯ÙŠÙƒ 15 Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‚Ø¨Ù„ Ø£Ù† ÙŠÙØ´Ù„ Ø§Ù„Ø¬ÙˆØ¨
        run: |
          Write-Host "=========================================================="
          Write-Host "âš ï¸ ACTION REQUIRED: CHECK THE LOGS BELOW âš ï¸"
          Write-Host "1. Look for a URL starting with https://login.tailscale.com/..."
          Write-Host "2. Copy and paste it into your browser to authenticate."
          Write-Host "3. Once approved, this workflow will automatically continue."
          Write-Host "=========================================================="
          
          # Ø§Ù„Ø£Ù…Ø± Ù‡Ù†Ø§ Ø³ÙŠØªÙˆÙ‚Ù ÙˆÙŠÙ†ØªØ¸Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
          & "C:\Program Files\Tailscale\tailscale.exe" up --hostname "github-rdp-manual"
          
          Write-Host "âœ… Successfully connected to Tailscale!"

      - name: â³ Keep Alive (355 Minutes)
        run: |
          $runtime = 355
          $end = (Get-Date).AddMinutes($runtime)
          Write-Host "RDP is now accessible via Tailscale IP."
          Write-Host "Session active for $runtime minutes..."
          
          while((Get-Date) -lt $end){
            $left = [int]([math]::Ceiling(($end - (Get-Date)).TotalMinutes))
            Write-Host "Alive... ($left minutes remaining)"
            Start-Sleep -Seconds 60
          }
          Write-Host "Time limit reached. Shutting down."
