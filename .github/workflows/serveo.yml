name: Windows RDP - Final Fix

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: ğŸ” Setup RDP User
        run: |
          $u="Bullettemporary"; $p="Bullet@12345"
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name $u -Password $sec -AccountNeverExpires -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group Administrators -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "User Prepared."

      - name: ğŸš€ Open Port & Capture Link
        shell: pwsh
        run: |
          Write-Host "Starting Tunnel..."
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ÙÙ‚ ÙˆØªÙˆØ¬ÙŠÙ‡ ÙƒÙ„ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù„Ù…Ù„Ù Ù†ØµÙŠ ÙÙˆØ±Ø§Ù‹
          $process = Start-Process ssh -ArgumentList "-o StrictHostKeyChecking=no -o ServerAliveInterval=60 -p 443 -R 0:localhost:3389 a.pinggy.io" -RedirectStandardOutput "tunnel_output.log" -PassThru
          
          Write-Host "Searching for your RDP link..."
          $found = $false
          $attempts = 0
          
          # Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø± Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„
          while (-not $found -and $attempts -lt 60) {
              if (Test-Path "tunnel_output.log") {
                  $content = Get-Content "tunnel_output.log" | Out-String
                  if ($content -match "tcp://[a-z0-9.-]+:[0-9]+") {
                      $link = [regex]::Match($content, "tcp://[a-z0-9.-]+:[0-9]+").Value
                      Write-Host "****************************************************"
                      Write-Host "SUCCESS! YOUR RDP ADDRESS IS:"
                      Write-Host $link
                      Write-Host "****************************************************"
                      $found = $true
                  }
              }
              Start-Sleep -Seconds 2
              $attempts++
          }
          
          if (-not $found) { 
            Write-Host "Failed to capture link. Printing raw log for debugging:"
            Get-Content "tunnel_output.log" 
          }

      - name: â³ Keep Connection Alive
        run: |
          Write-Host "RDP is active. Connection will stay open for 6 hours."
          for ($i=1; $i -le 350; $i++) {
              Write-Host "Session Alive... ($($i) min)"
              Start-Sleep -Seconds 60
          }
