name: Windows RDP (via Serveo)

on:
  workflow_dispatch:

concurrency:
  group: github-rdp-singleton
  cancel-in-progress: false

defaults:
  run:
    shell: pwsh

env:
  # --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù€ RDP ---
  RDP_USER: Bullettemporary
  RDP_PASS: Bullet@12345

jobs:
  rdp-session:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: ğŸ” Enable RDP Access
        run: |
          $u="${{ env.RDP_USER }}"; $p="${{ env.RDP_PASS }}"
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ØªØ­Ø¯ÙŠØ«Ù‡
          if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          } else {
            Set-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Enable-LocalUser -Name $u
          }
          # ÙØªØ­ Ø§Ù„Ù…Ù†ÙØ° ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          Write-Host "RDP User '$u' prepared."

      - name: ğŸŒ Connect to Serveo Tunnel
        run: |
          Write-Host "Starting Serveo Tunnel..."
          # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ø§Ù„Ø¨ÙˆØ±Øª 0 Ù„ÙŠÙ‚ÙˆÙ… Ø³ÙŠØ±ÙÙŠÙˆ Ø¨Ø¥Ø¹Ø·Ø§Ø¦Ùƒ Ø¨ÙˆØ±Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…ØªØ§Ø­
          # Ù„Ø£Ù† Ø¨ÙˆØ±Øª 3389 ØºØ§Ù„Ø¨Ø§Ù‹ Ù…Ø§ ÙŠÙƒÙˆÙ† Ù…Ø­Ø¬ÙˆØ²Ø§Ù‹ Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¢Ø®Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙÙŠÙˆ.
          Start-Process ssh -ArgumentList "-o StrictHostKeyChecking=no -o ServerAliveInterval=60 -R 0:localhost:3389 serveo.net" -NoNewWindow
          
          Write-Host "Waiting for tunnel to initialize..."
          Start-Sleep -Seconds 10
          Write-Host "Check the logs above or below for the assigned port from serveo.net"

      - name: â³ Keep Alive (355 Minutes)
        run: |
          $runtime = 355
          $end = (Get-Date).AddMinutes($runtime)
          Write-Host "Session active for $runtime minutes..."
          Write-Host "To Connect: Look for a line like 'Forwarding TCP from serveo.net:XXXXX' in the logs."
          
          while((Get-Date) -lt $end){
            $left = [int]([math]::Ceiling(($end - (Get-Date)).TotalMinutes))
            Write-Host "Alive... ($left minutes remaining)"
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ù€ SSH Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            Start-Sleep -Seconds 60
          }
          Write-Host "Time limit reached. Shutting down."
