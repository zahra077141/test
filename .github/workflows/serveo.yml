name: Windows RDP (via Serveo - Fixed)

on:
  workflow_dispatch:

concurrency:
  group: github-rdp-singleton
  cancel-in-progress: false

defaults:
  run:
    shell: pwsh

env:
  # --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù€ RDP ---
  RDP_USER: Bullettemporary
  RDP_PASS: Bullet@12345

jobs:
  rdp-session:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: ğŸ” Enable RDP Access
        run: |
          $u="${{ env.RDP_USER }}"; $p="${{ env.RDP_PASS }}"
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          } else {
            Set-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Enable-LocalUser -Name $u
          }
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          Write-Host "RDP User '$u' prepared."

      - name: ğŸŒ Connect to Serveo Tunnel
        run: |
          Write-Host "Starting Serveo Tunnel on port 44888..."
          # Ø·Ù„Ø¨ Ø¨ÙˆØ±Øª Ù…Ø­Ø¯Ø¯ (44888) Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù„Ù…Ù„Ù log
          $ssh_cmd = "ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -T -R 44888:localhost:3389 serveo.net"
          Start-Process powershell -ArgumentList "-Command $ssh_cmd > serveo.log 2>&1"
          
          Write-Host "Waiting for Serveo to assign a link..."
          Start-Sleep -Seconds 20
          
          # Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·
          if (Test-Path serveo.log) {
            Write-Host "-------------------------------------"
            Get-Content serveo.log
            Write-Host "-------------------------------------"
          } else {
            Write-Host "Error: serveo.log not found. Attempting backup connection..."
          }

      - name: â³ Keep Alive & Link Monitor
        run: |
          $runtime = 355
          $end = (Get-Date).AddMinutes($runtime)
          Write-Host "Session active for $runtime minutes..."
          
          while((Get-Date) -lt $end){
            $left = [int]([math]::Ceiling(($end - (Get-Date)).TotalMinutes))
            # Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø§Ø¨Ø· ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ù‚Ø§Ø¦Ù‡ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
            if (Test-Path serveo.log) {
               $content = Get-Content serveo.log | Select-Object -Last 5
               Write-Host "Status: $content ($left minutes remaining)"
            }
            Start-Sleep -Seconds 60
          }
          Write-Host "Time limit reached. Shutting down."
