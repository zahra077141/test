name: Windows RDP (Robust Connection)

on:
  workflow_dispatch:

concurrency:
  group: github-rdp-singleton
  cancel-in-progress: false

defaults:
  run:
    shell: pwsh

env:
  RDP_USER: Bullettemporary
  RDP_PASS: Bullet@12345

jobs:
  rdp-session:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: ðŸ” Prepare RDP Environment
        run: |
          $u="${{ env.RDP_USER }}"; $p="${{ env.RDP_PASS }}"
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          } else {
            Set-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Enable-LocalUser -Name $u
          }
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          Write-Host "User $u is ready for RDP."

      - name: ðŸš€ Launch Multi-Service Tunnel
        run: |
          Write-Host "Initializing connection via Pinggy (More stable for RDP)..."
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Pinggy ÙƒØ®ÙŠØ§Ø± Ø£ÙˆÙ„ Ù„Ø£Ù†Ù‡ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙˆØ±ØªØ§Øª Ø¨Ø°ÙƒØ§Ø¡
          $pinggy_cmd = "ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -p 443 -R 0:localhost:3389 a.pinggy.io"
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ÙÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
          Start-Process powershell -ArgumentList "-Command $pinggy_cmd > tunnel.log 2>&1"
          
          Write-Host "Waiting for the tunnel link to be generated..."
          Start-Sleep -Seconds 25
          
          if (Test-Path tunnel.log) {
            Write-Host "---------------- CONNECTION INFO ----------------"
            Get-Content tunnel.log | Select-String "tcp://"
            Write-Host "------------------------------------------------"
          }

      - name: â³ Persistent Monitoring
        run: |
          $end = (Get-Date).AddMinutes(355)
          Write-Host "Session is live. Monitoring tunnel status..."
          
          while((Get-Date) -lt $end){
            if (Test-Path tunnel.log) {
               # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡ Ø¨ÙˆØ¶ÙˆØ­
               $link = Get-Content tunnel.log | Select-String "tcp://" | Select-Object -Last 1
               if ($link) {
                   Write-Host "Connect here -> $link"
               } else {
                   Write-Host "Waiting for link... (Check logs if it takes too long)"
               }
            }
            Start-Sleep -Seconds 60
          }
